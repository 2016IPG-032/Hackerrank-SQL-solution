select X.submission_date,Y.cts,X.hacker_id,X.name FROM (select submission_date ,hacker_id, name,ctz from ( select submission_date ,hacker_id, name,ctz, row_number() OVER (PARTITION BY submission_date ORDER BY ctz desc,hacker_id asc ) as rown from ( select a.submission_date as submission_date ,a.hacker_id as hacker_id,b.name as name, count(*) ctz from submissions a inner join hackers b on a.hacker_id=b.hacker_id group by a.submission_date,a.hacker_id,b.name)) where rown=1 ) X, (select submission_date,count(distinct hacker_id) as cts from (SELECT submission_date,hacker_id,suma from ( SELECT submission_date,hacker_id , SUM(brk_flag) OVER (PARTITION BY hacker_id ORDER BY submission_date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ) as suma FROM (SELECT submission_date,hacker_id, prev_date,(CASE WHEN ( submission_date - prev_date) > 1 THEN 1 ELSE 0 END) AS brk_flag FROM (SELECT submission_date,hacker_id , MAX(submission_date) OVER( PARTITION BY hacker_id ORDER BY submission_date ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS prev_date FROM submissions where hacker_id in ( select distinct hacker_id from submissions where submission_date= to_date('01-03-2016' , 'DD-MM-YYYY') ) order by hacker_id,submission_date))) where suma=0 ) group by submission_date order by submission_date ) Y where x.submission_date=y.submission_date;
